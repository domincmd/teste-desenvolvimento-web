<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokedéx</title>
    <link rel="stylesheet" href="../static/styles.css">
</head>
<body>
    <div class="general-container">
        <div class="search-filter-container">
            <div class="search-container">
                <span>Name:</span><br>
                <input type="text" name="name-of-pokemon" id="name-of-pokemon">
               <button onclick="sendData('str')">Submit</button>
               <button onclick="sendData('int')">Submit Int</button><br>
            </div>
            
            
            
        </div>
        <div class="view-container">

        </div>
        <div class="action-container">
            <button onclick="queryRemoval()">-</button>
            <button onclick="queryAddition()">+</button><br>
            <button onclick="queryUpdate()" class="double">Upd</button>
        </div>
    </div>
</body>
<script>
const searchFilterContainer = document.querySelector(".search-filter-container")
const viewContainer = document.querySelector(".view-container")

function queryAddition() {
    const toAdd = JSON.parse(prompt("what to add bruh"));

    //set what element to add here

    fetch('/search/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(toAdd), // Send name as JSON
    })
    .then(response => response.json())
    .then(data => {
        if (data.result != true) {
            alert(data.status)
        } else{
            alert("successfully updated the database!")
        }
        
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function queryUpdate() {
    fetch('/search/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        //body: JSON.stringify({ pokemon: pokemonI }), // Send name as JSON
    })
    .then(response => response.json())
    .then(data => {
        if (data.result != true) {
            alert(data.status)
        } else{
            alert("successfully updated the database!")
        }
        
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function queryRemoval() {
    if (viewContainer.querySelector(".card")) {
        const pokemonI = document.querySelector(".card").querySelector(".row").innerHTML.slice(5)
        fetch('/search/remove', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ pokemon: pokemonI }), // Send name as JSON
        })
        .then(response => response.json())
        .then(data => {
            alert(data)
            
        })
        .catch(error => {
            console.error('Error:', error);
        });


    }else{
        alert("select a card before removing it!")
        return null;
    }
}


function displayFilterResults(filters) {
    const resultContainer = document.createElement("div")
    resultContainer.classList.add("filter-results")


    filters.answer.forEach(i => {
        const iDisplay = document.createElement("span")
        const br = document.createElement("br")
        iDisplay.textContent = i.Name;
        resultContainer.appendChild(iDisplay)
        resultContainer.appendChild(br)
    })

    return resultContainer;
}

function getFiltersFrontend() {
    const filterDiv = document.querySelector(".filter-container");

    let filters = []

    for (let i = 0; i < filterDiv.childNodes.length-1; i++) {
        const currentDiv = filterDiv.childNodes[i];

        if (currentDiv.nodeType === 1) { // Ensure it's an element node
            const filter = currentDiv.querySelector("span").textContent;
            const filterState = currentDiv.querySelector("input").checked;

            if (filterState) {
                filters.push(filter)
            }

            console.log("FILTER: " + filter + "\nSTATE: " + filterState);
        }
    }

    return filters;
}


function displayFilters(filters) {
    const filtersDiv = document.createElement("div")
    filtersDiv.classList.add("filter-container")

    const filterButton = document.createElement("button");
    filterButton.textContent = "Filter";
    filterButton.addEventListener("click", e => {
        const filters = getFiltersFrontend()

        searchFiltered(filters)
        
    });
    

    for (let i = 0; i < filters.length; i++) {
        const currentDiv = document.createElement("div")
        currentDiv.classList.add("filter")
        currentDiv.classList.add(i)

        const currentInput = document.createElement("input")
        currentInput.type = "checkbox";
        currentDiv.appendChild(currentInput)

        const currentInputText = document.createElement("span")
        currentInputText.textContent = filters[i]
        currentDiv.appendChild(currentInputText)

        filtersDiv.appendChild(currentDiv)
    }

    filtersDiv.appendChild(filterButton)

    return filtersDiv;
}


// Function to display data
function displayData(data) {
    const cardContainer = document.createElement("div");
    cardContainer.classList.add("card");

    // Loop through the object keys and values
    Object.keys(data).forEach(key => {
        const createdElement = document.createElement("span");
        createdElement.textContent = `${key}: ${data[key]}`; // Display key and value
        createdElement.classList.add(key.toLowerCase().replace(/ /g, "-"));
        cardContainer.appendChild(createdElement);
    });

    console.log(cardContainer)

    return cardContainer;
}

function getFiltersBackend() {
    fetch('/search/filters', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }//,
        //body: JSON.stringify({ message: "get checkboxes" }), // Send name as JSON
    })
    .then(response => response.json())
    .then(data => {
        searchFilterContainer.appendChild(displayFilters(data))
        
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

// Function to send data
function sendData(type) {
    const pokemon = document.getElementById('name-of-pokemon').value;

    // Validate if input is not empty
    if (!pokemon) {
        alert("Please enter a Pokémon name");
        return;
    }

    // Fetch request to send the Pokémon name
    fetch('/search/search', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ pokemon: pokemon, type: type }), // Send name as JSON
    })
    .then(response => response.json())
    .then(data => {
        // Clear the view-container before displaying new data
        const viewContainer = document.querySelector(".view-container");
        viewContainer.innerHTML = ""; // Clear previous content
        console.log(data.Name)
        // Append the new card
        viewContainer.appendChild(displayData(data));
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function searchFiltered(presentFilters) {
    fetch('/search/search-filtered', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ filters: presentFilters }), // Send name as JSON
    })
    .then(response => response.json())
    .then(data => {
        // Clear the view-container before displaying new data
        console.log(data)
        const filtersDiv = displayFilterResults(data)
        
        if (searchFilterContainer.querySelector(".filter-results")) {
            searchFilterContainer.removeChild(searchFilterContainer.querySelector(".filter-results"))
        }
        
        searchFilterContainer.appendChild(filtersDiv)
    })
    .catch(error => {
        console.error('Error:', error);
    });
}


//call functions

getFiltersBackend()
</script>
</html>
